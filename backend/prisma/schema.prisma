generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  admin
  user
}

enum UserPlan {
  free
  pro
  elite
}

enum SessionType {
  chat
  builder
  automation
  solver
}

enum MessageRole {
  user
  assistant
  system
}

enum SubscriptionStatus {
  active
  canceled
  past_due
  trialing
  incomplete
}

enum PaymentStatus {
  pending
  succeeded
  failed
  refunded
}

enum DeploymentTarget {
  vps
  do
  other
}

enum DeploymentStatus {
  queued
  running
  success
  failed
}

model User {
  id           String    @id @default(uuid())
  email        String    @unique
  passwordHash String
  role         UserRole  @default(user)
  plan         UserPlan  @default(free)
  name         String?
  avatarUrl    String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  projects      Project[]
  subscriptions Subscription[]
  payments      Payment[]
  deployments   Deployment[]
  files         File[]

  @@map("users")
}

model Project {
  id          String   @id @default(uuid())
  userId      String
  title       String
  description String?
  status      String   @default("active")
  metadata    Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  user     User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessions Session[]

  @@map("projects")
}

model Session {
  id        String      @id @default(uuid())
  projectId String
  type      SessionType @default(chat)
  title     String?
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  project  Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  messages Message[]

  @@map("sessions")
}

model Message {
  id        String      @id @default(uuid())
  sessionId String
  role      MessageRole
  content   String
  metadata  Json?
  createdAt DateTime    @default(now())

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@map("messages")
}

model Subscription {
  id               String             @id @default(uuid())
  userId           String
  provider         String             @default("stripe")
  plan             UserPlan
  status           SubscriptionStatus @default(active)
  externalId       String?
  currentPeriodEnd DateTime?
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("subscriptions")
}

model Payment {
  id         String        @id @default(uuid())
  userId     String
  provider   String
  amount     Int
  currency   String        @default("usd")
  status     PaymentStatus @default(pending)
  externalId String?
  metadata   Json?
  createdAt  DateTime      @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("payments")
}

model Deployment {
  id        String           @id @default(uuid())
  userId    String
  target    DeploymentTarget @default(vps)
  status    DeploymentStatus @default(queued)
  logs      String?
  config    Json?
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("deployments")
}

model File {
  id        String   @id @default(uuid())
  userId    String
  filename  String
  path      String
  mimetype  String
  size      Int
  createdAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("files")
}

model Setting {
  key       String   @id
  value     Json
  updatedAt DateTime @updatedAt

  @@map("settings")
}
